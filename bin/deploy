#!/usr/bin/env sh

# Run this script to deploy the app to Github Pages.

# Exit if any subcommand fails.
set -e

echo "Started deploying"

# BRANCH=${BRANCH:-gh-pages}
BRANCH=${BRANCH:-master}

if [ "$BRANCH" == gh-pages ]; then
  # Checkout gh-pages branch.
  if git branch | grep -q ^gh-pages\$; then
    git branch -D gh-pages
  fi
  git checkout -b gh-pages
fi

# Build site.
bower install
bundle exec jekyll build

if [ "$BRANCH" == gh-pages ]; then
  # Delete and move files.
  find . -maxdepth 1 ! -name _site ! -name .git ! -name .gitignore -exec rm -rf {} \;
  mv _site/* .
  rm -R _site/
fi

# Push to $BRANCH (gh-pages or master).
if [ "$BRANCH" == gh-pages ]; then
  git add -fA
else
  # We remove the '-f' option because we need the .gitignore to be observed!
  git add -A
fi
git commit --allow-empty -m "`git log -1 --pretty=%B` [ci skip]"
git push -f -q origin "$BRANCH"

if [ "$BRANCH" == gh-pages ]; then
  # Move back to previous branch.
  git checkout -
  bower install
fi

echo "Deployed Successfully!"

exit 0
